ALTER proc dbo.[CCDA2715_Sharp_Sarcoidosis_sp] AS
/**********************************************************************************
Author:  Michael Cook
Date: 7/13/2021
JIRA: CCDA-2715
Description: A one-time extract of Adult patients residing in MD seen at the Johns Hopkins Sarcoidosis Clinic. 
This proc creates all tables: demographics, encounters, PFT's, Social_Hx. The patient cohort is based on a patient list,
with the ID provided by the study team.
Example:
    EXEC dbo.[CCDA2715_Sharp_Sarcoidosis_sp]
     
Revision History:
Date            Author          JIRA            Comment
7/13/2021      Michael Cook     CCDA-2715       Combined all procs into one, per Guanyu's code review
10/18/2021      Michael Cook     CCDA-2715       Removed Antibody tests from PCR 
01/11/2022      Michael Cook     CCDA-2715       Added EMRN to all files
06/02/2022		Michael Cook	CCDA-2715		Added hospital encounter (3) to encounter types; updated cohort since the epic list got deleted
***********************************************************************************/

SET NOCOUNT ON;

--Demographics
drop table if exists #temp_coh;

select distinct EMRN
into #temp_coh
FROM Analytics.dbo.CCDA2715_Sharp_Demographics;

drop table if exists Analytics.dbo.CCDA2715_Sharp_Demographics;

/*
--Epic patientlist got deleted, so coh has to be defined based on curr coh
WITH COH AS (
SELECT DISTINCT PAT_ID
FROM CLARITY..PAT_LIST
where LIST_ID = '630939'
),
*/
WITH COH AS (
SELECT DISTINCT II.PAT_ID
FROM #temp_coh
INNER JOIN CLARITY..IDENTITY_ID II ON II.IDENTITY_ID = #temp_coh.EMRN and II.IDENTITY_TYPE_ID = 0
),

PCR AS (
SELECT PAT_ID, min(RESULT_DTM) "First_Positive_PCR"
FROM [Analytics].[dbo].[CovidAllTests_v4]
WHERE POSITIVE_YN = 'Y'
AND TEST_TYPE_1 <> 'Antibody' --Not Antibody tests
GROUP BY PAT_ID
),

CCI AS (
SELECT NETWORKED_ID
                    ,METRICS_ID, CCR.RULE_NAME
                    ,cast(RDM.METRIC_STRING_VALUE as varchar) "CCI_Score"
                    ,cast(RDM.METRIC_LAST_UPD_TM as varchar) "Date"
                from CLARITY.dbo.REG_DATA_METRICS RDM 
                INNER JOIN    CLARITY.dbo.CL_CHRG_EDIT_RULE CCR ON CCR.RULE_ID = RDM.METRICS_ID
                INNER JOIN    CLARITY.dbo.REGISTRY_DATA_INFO RDI ON RDI.RECORD_ID = RDM.RECORD_ID
                INNER JOIN    CLARITY..PATIENT pat1 on rdi.networked_id=pat1.pat_id
                WHERE RDM.METRICS_ID IN ('2101500001')
)

Select II.IDENTITY_ID "EMRN", PT.PAT_MRN_ID "Preferred_MRN", zps.[NAME] "Status",
pt.DEATH_DATE "Death_Date", CCI.CCI_Score, PCR.First_Positive_PCR, cen.Census_Tract
INTO Analytics.dbo.CCDA2715_Sharp_Demographics
FROM Clarity..PATIENT PT
INNER JOIN COH ON COH.PAT_ID = Pt.PAT_ID
INNER JOIN CLARITY..IDENTITY_ID II ON II.PAT_ID = PT.PAT_ID and II.IDENTITY_TYPE_ID = 0
LEFT JOIN CLARITY..PATIENT_4 PT4 on PT.PAT_ID = PT4.PAT_ID
LEFT JOIN CLARITY..ZC_SEX ZS ON ZS.RCPT_MEM_SEX_C = PT.SEX_C
LEFT JOIN CLARITY..ZC_ETHNIC_GROUP ETG ON ETG.ETHNIC_GROUP_C = PT.ETHNIC_GROUP_C
left JOIN CLARITY.dbo.ZC_MARITAL_STATUS zms on PT.MARITAL_STATUS_C = zms.MARITAL_STATUS_C
LEFT JOIN CLARITY..ZC_PAT_LIVING_STAT zps on pt4.PAT_LIVING_STAT_C = zps.PAT_LIVING_STAT_C
LEFT JOIN PCR on PT.PAT_ID = PCR.PAT_ID
LEFT JOIN CCI ON CCI.NETWORKED_ID = PT.PAT_ID
LEFT JOIN Analytics.dbo.CCDA2715_Sharp_Census_Tract cen on COH.PAT_ID = cen.PAT_ID;

ALTER TABLE [Analytics].[dbo].[CCDA2715_Sharp_Demographics] REBUILD PARTITION = ALL  WITH (DATA_COMPRESSION = Page);

--Encounters

drop table if exists Analytics.dbo.CCDA2715_Sharp_Encounters;


WITH COH AS (
SELECT DISTINCT II.PAT_ID
FROM #temp_coh
INNER JOIN CLARITY..IDENTITY_ID II ON II.IDENTITY_ID = #temp_coh.EMRN and II.IDENTITY_TYPE_ID = 0
),

ENC AS (
SELECT *
FROM CLARITY..PAT_ENC
WHERE ENC_TYPE_C IN ( '1000', '1001', '1003', '1004', '101', '108', '1199', 
'1200', '1201', '121', '1214', '2', '200', '210', '2100', '2101',
'2501', '2502', '2508', '2520', '2521', '2522', '2525', '2526', '2529',
'2531', '50', '62', '76', '81', '91', '20', '55', '3')
and APPT_STATUS_C = 2
AND EFFECTIVE_DATE_DTTM >= '2017-01-01'
),

HT AS
(
	SELECT A.*,ROW_NUMBER()OVER (partition BY PAT_ID,PAT_ENC_CSN_ID ORDER BY DD) AS RN
	FROM (SELECT DISTINCT
			S.PAT_ID
			,pe.PAT_ENC_CSN_ID
			,IP_FLWSHT_MEAS.MEAS_VALUE
			,flwgp.DISP_NAME
			,IP_FLWSHT_MEAS.recorded_time
			,flwgp.flo_MEAS_id
			,ABS(DATEDIFF(MINUTE,IP_FLWSHT_MEAS.recorded_time,pe.EFFECTIVE_DATE_DTTM)) AS DD
		FROM 
			COH S
			INNER JOIN ENC pe ON PE.PAT_ID = S.PAT_ID
			INNER JOIN CLARITY.dbo.IP_FLWSHT_REC IP_FLWSHT_REC  ON PE.INPATIENT_DATA_ID=IP_FLWSHT_REC.INPATIENT_DATA_ID
			INNER JOIN CLARITY.dbo.IP_FLWSHT_MEAS IP_FLWSHT_MEAS  ON IP_FLWSHT_REC.FSD_ID=IP_FLWSHT_MEAS.FSD_ID
			inner join clarity.dbo.IP_FLO_GP_DATA flwgp on flwgp.FLO_MEAS_ID=IP_FLWSHT_MEAS.FLO_MEAS_ID
			INNER JOIN CLARITY.DBO.IP_FLT_DATA TMP ON TMP.TEMPLATE_ID = IP_FLWSHT_MEAS.FLT_ID
		WHERE  
		IP_FLWSHT_MEAS.FLO_MEAS_ID IS NOT NULL
		AND flwgp.flo_MEAS_id IN (
								 '11') ) A	
),

WT AS
(
	SELECT A.*,ROW_NUMBER()OVER (partition BY PAT_ID,PAT_ENC_CSN_ID ORDER BY DD) AS RN
	FROM (SELECT DISTINCT
			S.PAT_ID
			,pe.PAT_ENC_CSN_ID
			,IP_FLWSHT_MEAS.MEAS_VALUE
			,flwgp.DISP_NAME
			,IP_FLWSHT_MEAS.recorded_time
			,flwgp.flo_MEAS_id
			,ABS(DATEDIFF(MINUTE,IP_FLWSHT_MEAS.recorded_time,pe.EFFECTIVE_DATE_DTTM)) AS DD
		FROM 
			COH S
			INNER JOIN ENC pe ON PE.PAT_ID = S.PAT_ID
			INNER JOIN CLARITY.dbo.IP_FLWSHT_REC IP_FLWSHT_REC  ON PE.INPATIENT_DATA_ID=IP_FLWSHT_REC.INPATIENT_DATA_ID
			INNER JOIN CLARITY.dbo.IP_FLWSHT_MEAS IP_FLWSHT_MEAS  ON IP_FLWSHT_REC.FSD_ID=IP_FLWSHT_MEAS.FSD_ID
			inner join clarity.dbo.IP_FLO_GP_DATA flwgp on flwgp.FLO_MEAS_ID=IP_FLWSHT_MEAS.FLO_MEAS_ID
			INNER JOIN CLARITY.DBO.IP_FLT_DATA TMP ON TMP.TEMPLATE_ID = IP_FLWSHT_MEAS.FLT_ID
		WHERE  
		IP_FLWSHT_MEAS.FLO_MEAS_ID IS NOT NULL
		AND flwgp.flo_MEAS_id IN (
								 '14') ) A	
),

BMI AS
(
	SELECT A.*,ROW_NUMBER()OVER (partition BY PAT_ID,PAT_ENC_CSN_ID ORDER BY DD) AS RN
	FROM (SELECT DISTINCT
			S.PAT_ID
			,pe.PAT_ENC_CSN_ID
			,IP_FLWSHT_MEAS.MEAS_VALUE
			,flwgp.DISP_NAME
			,IP_FLWSHT_MEAS.recorded_time
			,flwgp.flo_MEAS_id
			,ABS(DATEDIFF(MINUTE,IP_FLWSHT_MEAS.recorded_time,pe.EFFECTIVE_DATE_DTTM)) AS DD
		FROM 
			COH S
			INNER JOIN ENC pe ON PE.PAT_ID = S.PAT_ID
			INNER JOIN CLARITY.dbo.IP_FLWSHT_REC IP_FLWSHT_REC  ON PE.INPATIENT_DATA_ID=IP_FLWSHT_REC.INPATIENT_DATA_ID
			INNER JOIN CLARITY.dbo.IP_FLWSHT_MEAS IP_FLWSHT_MEAS  ON IP_FLWSHT_REC.FSD_ID=IP_FLWSHT_MEAS.FSD_ID
			inner join clarity.dbo.IP_FLO_GP_DATA flwgp on flwgp.FLO_MEAS_ID=IP_FLWSHT_MEAS.FLO_MEAS_ID
			INNER JOIN CLARITY.DBO.IP_FLT_DATA TMP ON TMP.TEMPLATE_ID = IP_FLWSHT_MEAS.FLT_ID
		WHERE  
		IP_FLWSHT_MEAS.FLO_MEAS_ID IS NOT NULL
		AND flwgp.flo_MEAS_id IN (
								 '301070') ) A	
)

Select DISTINCT II.IDENTITY_ID "EMRN", enc.PAT_ENC_CSN_ID, enc.EFFECTIVE_DATE_DTTM "Encounter_Date",
ze.[NAME] "Encounter_Type", dep.DEPARTMENT_NAME, dep.SPECIALTY "Dep_Specialty", occ.HX_OCCUPN "Pat_Occupation",
CAST(HT.MEAS_VALUE AS numeric) "Height_In_Inches", CAST(WT.MEAS_VALUE AS numeric) "Weight_In_Ounces",
BMI.MEAS_VALUE "BMI"
INTO Analytics.dbo.CCDA2715_Sharp_Encounters
FROM Clarity..PATIENT PT
INNER JOIN COH ON COH.PAT_ID = Pt.PAT_ID
INNER JOIN CLARITY..IDENTITY_ID II ON II.PAT_ID = PT.PAT_ID and II.IDENTITY_TYPE_ID = 0
INNER JOIN ENC enc on COH.PAT_ID = enc.PAT_ID
INNER JOIN HT ON ENC.PAT_ENC_CSN_ID = HT.PAT_ENC_CSN_ID AND HT.RN = 1
INNER JOIN WT ON ENC.PAT_ENC_CSN_ID = WT.PAT_ENC_CSN_ID AND WT.RN = 1
INNER JOIN BMI ON ENC.PAT_ENC_CSN_ID = BMI.PAT_ENC_CSN_ID AND BMI.RN = 1
LEFT JOIN CLARITY..ZC_DISP_ENC_TYPE ze on enc.ENC_TYPE_C = ze.DISP_ENC_TYPE_C
LEFT JOIN CLARITY..CLARITY_DEP dep on enc.EFFECTIVE_DEPT_ID = dep.DEPARTMENT_ID AND (dep.SERV_AREA_ID = 11 or dep.SERV_AREA_ID is NULL)
LEFT JOIN CLARITY..PAT_OCCUPN_HX occ on coh.PAT_ID = occ.PAT_ID AND occ.LINE = 1
ORDER BY II.IDENTITY_ID, enc.EFFECTIVE_DATE_DTTM;


UPDATE [Analytics].[dbo].[CCDA2715_Sharp_Encounters]
SET BMI = ROUND((((weight_in_ounces / 16.0)/(height_in_inches * height_in_inches))*703), 1)
WHERE BMI is NULL;


ALTER TABLE [Analytics].[dbo].[CCDA2715_Sharp_Encounters] REBUILD PARTITION = ALL  WITH (DATA_COMPRESSION = Page);

--PFT

drop table if exists Analytics.dbo.CCDA2715_Sharp_Sarcoidosis_PFT;


WITH COH AS (
SELECT DISTINCT II.PAT_ID
FROM #temp_coh
INNER JOIN CLARITY..IDENTITY_ID II ON II.IDENTITY_ID = #temp_coh.EMRN and II.IDENTITY_TYPE_ID = 0
),

ENC AS (
SELECT DISTINCT enc.PAT_ID, enc.PAT_ENC_CSN_ID
FROM CLARITY..PAT_ENC enc
INNER JOIN CLARITY..CLARITY_DEP dep on enc.DEPARTMENT_ID = dep.DEPARTMENT_ID 
WHERE enc.ENC_TYPE_C IN ( '1000', '1001', '1003', '1004', '101', '108', '1199', 
'1200', '1201', '121', '1214', '2', '200', '210', '2100', '2101',
'2501', '2502', '2508', '2520', '2521', '2522', '2525', '2526', '2529',
'2531', '50', '62', '76', '81', '91', '20', '55','3')
AND (dep.SERV_AREA_ID = 11 OR dep.SERV_AREA_ID IS NULL)
AND enc.EFFECTIVE_DATE_DTTM >= '2017-01-01'
),

COMP AS (
SELECT *
FROM CLARITY..CLARITY_COMPONENT
WHERE COMPONENT_ID in ('9400000009','9400000073','9400000066','9400000025','9400000024',
'9400000012','9400000019','9400000016','9400000067','9400000013','9400000005','9400000069',
'9400000006','9400000002','9400000052','9400000051','9400000048','9400000047','9400000009',
'9400000073','9400000066','9400000025','9400000024','9400000012','9400000019','9400000016',
'9400000067','9400000013','9400000005','9400000069','9400000006','9400000002','9400000052',
'9400000051','9400000048','9400000047','9400000009','9400000073','9400000066','9400000025',
'9400000024','9400000012','9400000019','9400000016','9400000067','9400000013','9400000005',
'9400000069','9400000006','9400000002','9400000052','9400000051','9400000048','9400000047',
'9400000009','9400000073','9400000066','9400000025','9400000024','9400000012','9400000019',
'9400000016','9400000067','9400000013','9400000005','9400000069','9400000006','9400000002',
'9400000052','9400000051','9400000048','9400000047','970000195','970000196','970000191',
'970000189','970000190','970000192','970000193','970000194','970000195','970000196','970000191',
'9300000301','970000192','970000194','9300000502','9300000503')
),

PROCS AS (
SELECT *
FROM CLARITY..CLARITY_EAP eap
WHERE eap.proc_id in(
	'101818',
	'102635',
	'160072',
	'187213',
	'122897',
	'127027')
)

Select DISTINCT II.IDENTITY_ID "EMRN",enc.PAT_ENC_CSN_ID, eap.PROC_NAME, ord.ORDER_TIME
,eap.PROC_ID,
eap.proc_code, eap.ORDER_DISPLAY_NAME, cc.component_id, 
cc.BASE_NAME, cc.name as ComponentName, cc.EXTERNAL_NAME,
res.ORD_NUM_VALUE
INTO Analytics.dbo.CCDA2715_Sharp_Sarcoidosis_PFT
FROM COH 
INNER JOIN CLARITY..PATIENT Pt ON COH.PAT_ID = Pt.PAT_ID
INNER JOIN CLARITY..IDENTITY_ID II ON II.PAT_ID = PT.PAT_ID and II.IDENTITY_TYPE_ID = 0
INNER JOIN ENC enc on COH.PAT_ID = enc.PAT_ID
inner join CLARITY..order_proc ord on ENC.PAT_ENC_CSN_ID = ord.PAT_ENC_CSN_ID
inner join PROCS eap on eap.PROC_ID = ord.PROC_ID
inner join CLARITY..order_results res on ord.ORDER_PROC_ID = res.ORDER_PROC_ID
inner join COMP cc on cc.COMPONENT_ID = res.COMPONENT_ID
WHERE (res.RESULT_STATUS_C IN (3,4))
AND ord.ORDER_TIME >= '2017-01-01'
order by proc_name, cc.base_name;

ALTER TABLE [Analytics].[dbo].[CCDA2715_Sharp_Sarcoidosis_PFT] REBUILD PARTITION = ALL  WITH (DATA_COMPRESSION = Page);

--Social Hx

drop table if exists Analytics.dbo.CCDA2715_Sharp_Sarcoidosis_Social_Hx;


WITH COH AS (
SELECT DISTINCT II.PAT_ID
FROM #temp_coh
INNER JOIN CLARITY..IDENTITY_ID II ON II.IDENTITY_ID = #temp_coh.EMRN and II.IDENTITY_TYPE_ID = 0
),

HX AS (
SELECT A.*,ROW_NUMBER()OVER (partition BY PAT_ID ORDER BY PAT_ID, CONTACT_DATE desc) AS RN
FROM
	(
		Select *
		from CLARITY..SOCIAL_HX
	) A
)

Select DISTINCT II.IDENTITY_ID "EMRN", zs.[NAME] "Smoking_Status", soc.TOBACCO_PAK_PER_DY "Packs_Per_Day",
soc.SMOKING_QUIT_DATE, za.[NAME] "Alcohol_Use", zi.[NAME] "Illicit_Drug_Use"
INTO Analytics.dbo.CCDA2715_Sharp_Sarcoidosis_Social_Hx
FROM HX soc
INNER JOIN COH ON COH.PAT_ID = soc.PAT_ID AND soc.RN = 1
INNER JOIN CLARITY..IDENTITY_ID II ON II.PAT_ID = COH.PAT_ID and II.IDENTITY_TYPE_ID = 0
LEFT JOIN CLARITY..ZC_SMOKING_TOB_USE zs on soc.SMOKING_TOB_USE_C = zs.SMOKING_TOB_USE_C
LEFT JOIN CLARITY..ZC_ALCOHOL_USE za on soc.ALCOHOL_USE_C = za.ALCOHOL_USE_C
LEFT JOIN CLARITY..ZC_ILL_DRUG_USER zi on soc.ILL_DRUG_USER_C = zi.ILL_DRUG_USER_C
ORDER BY II.IDENTITY_ID;

ALTER TABLE [Analytics].[dbo].[CCDA2715_Sharp_Sarcoidosis_Social_Hx] REBUILD PARTITION = ALL  WITH (DATA_COMPRESSION = Page)