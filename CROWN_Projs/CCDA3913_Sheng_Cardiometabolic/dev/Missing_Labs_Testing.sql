WITH COH AS (
SELECT DISTINCT PAT_ID
FROM [Analytics].[dbo].[CCDA3913_Sheng_Demographics] PT
INNER JOIN CLARITY..IDENTITY_ID II ON II.IDENTITY_ID = PT.EMRN and II.IDENTITY_TYPE_ID = 0
),

COMP AS (
SELECT *
FROM CLARITY.DBO.CLARITY_COMPONENT
WHERE COMPONENT_ID IN (
      '8100004657', '8100000152', '2000000321', '7200000067', '3000000337', '7100002264', '9700000018', 
      '1233000390', '6000000257', '9300000671', '7000002104', '5000001431', '4000000219', '7000002103', 
      '8200000008', '8100004638', '8100004645', '7100002266', '9700000020', '4000000222', '8100000149', 
      '7200000072', '8100004655', '5000001433', '7000002239', '7100000308', '9300000672', '2000000323', 
      '1233000392', '8200000357', '3000000339', '6000000359', '6000000392', '5000001434', '3000000340', 
      '9300000678', '7100002267', '1233000393', '2000000324', '820001447', '7100000309', '8200000373', 
      '7000002321', '4000000220', '8100000044', '7200000069', '8100000719', '9700000021', '1233000222', 
      '8100004656', '9700000036', '820001445', '7000002388', '8100004658', '8100000321', '7100000310', 
      '8100000362', '7100002268', '1233000125', '2100002294', '8100000609', '2000000325', '5000001435', 
      '1233000394', '3000000341', '7200000073', '7100000307', '820001446', '7000002577', '6000000644', 
      '7100002265', '1233000391', '7200000068', '8200000021', '9300000674', '2000000322', '9700000019', 
      '8100000225', '3000000338', '8100004637', '7100000306', '4000000308', '5000001432', '7200000071', 
      '8200000368', '7000002690'
      ) --Hba1c & Lipid panel
)
SELECT top 10 *
FROM COH 
INNER JOIN CLARITY..order_proc ord ON ord.PAT_ID = COH.PAT_ID
INNER JOIN CLARITY.DBO.CLARITY_EAP eap ON eap.PROC_ID = ord.PROC_ID
INNER JOIN CLARITY.DBO.order_results res ON ord.ORDER_PROC_ID = res.ORDER_PROC_ID
INNER JOIN COMP cc ON cc.COMPONENT_ID = res.COMPONENT_ID;

WITH COH AS (
SELECT DISTINCT PAT_ID
FROM [Analytics].[dbo].[CCDA3913_Sheng_Demographics] PT
INNER JOIN CLARITY..IDENTITY_ID II ON II.IDENTITY_ID = PT.EMRN and II.IDENTITY_TYPE_ID = 0
),

COMP AS (
SELECT *
FROM CLARITY.DBO.CLARITY_COMPONENT
WHERE COMPONENT_ID IN (
      '8100004657', '8100000152', '2000000321', '7200000067', '3000000337', '7100002264', '9700000018', 
      '1233000390', '6000000257', '9300000671', '7000002104', '5000001431', '4000000219', '7000002103', 
      '8200000008', '8100004638', '8100004645', '7100002266', '9700000020', '4000000222', '8100000149', 
      '7200000072', '8100004655', '5000001433', '7000002239', '7100000308', '9300000672', '2000000323', 
      '1233000392', '8200000357', '3000000339', '6000000359', '6000000392', '5000001434', '3000000340', 
      '9300000678', '7100002267', '1233000393', '2000000324', '820001447', '7100000309', '8200000373', 
      '7000002321', '4000000220', '8100000044', '7200000069', '8100000719', '9700000021', '1233000222', 
      '8100004656', '9700000036', '820001445', '7000002388', '8100004658', '8100000321', '7100000310', 
      '8100000362', '7100002268', '1233000125', '2100002294', '8100000609', '2000000325', '5000001435', 
      '1233000394', '3000000341', '7200000073', '7100000307', '820001446', '7000002577', '6000000644', 
      '7100002265', '1233000391', '7200000068', '8200000021', '9300000674', '2000000322', '9700000019', 
      '8100000225', '3000000338', '8100004637', '7100000306', '4000000308', '5000001432', '7200000071', 
      '8200000368', '7000002690'
      ) --Hba1c & Lipid panel

)

SELECT DISTINCT --eap.PROC_NAME, cc.BASE_NAME, cc.name AS ComponentName, cc.EXTERNAL_NAME, 
--eap.PROC_ID, eap.proc_code, eap.ORDER_DISPLAY_NAME,
cc.component_id, cc.External_name, cc.base_name
--INTO Analytics.dbo.CCDA3913_Sheng_Lab_Results
FROM COH
INNER JOIN CLARITY.DBO.PATIENT Pt ON COH.PAT_ID = Pt.PAT_ID
INNER JOIN CLARITY.DBO.IDENTITY_ID II ON II.PAT_ID = PT.PAT_ID AND II.IDENTITY_TYPE_ID = 0
INNER JOIN CLARITY.DBO.PAT_ENC enc ON COH.PAT_ID = enc.PAT_ID
INNER JOIN CLARITY..order_proc ord ON ENC.PAT_ENC_CSN_ID = ord.PAT_ENC_CSN_ID
INNER JOIN CLARITY.DBO.CLARITY_EAP eap ON eap.PROC_ID = ord.PROC_ID
INNER JOIN CLARITY.DBO.order_results res ON ord.ORDER_PROC_ID = res.ORDER_PROC_ID
INNER JOIN COMP cc ON cc.COMPONENT_ID = res.COMPONENT_ID
LEFT JOIN CLARITY.DBO.ORDER_RES_COMMENT cmt ON res.ORDER_PROC_ID = cmt.ORDER_ID
LEFT JOIN CLARITY.DBO.CLARITY_DEP dep ON enc.EFFECTIVE_DEPT_ID = dep.DEPARTMENT_ID
LEFT JOIN CLARITY.DBO.CLARITY_SER prov ON enc.VISIT_PROV_ID = prov.PROV_ID
WHERE (res.RESULT_STATUS_C IN (3, 4))
ORDER BY cc.EXTERNAL_NAME, cc.base_name;
